
<!-- <script src="msum.js"></script> -->
<script type="module" src="https://unpkg.com/@wasmer/wasi@0.12.0/lib/index.esm.js"></script>
<script  type="module">
    // console.log(Module)
   
    // fetch('perspective.wasm')
    //   .then(response => response.arrayBuffer())
    //   .then(bytes => WebAssembly.compile(bytes))
    //   .then(module => {
    //     console.log(WebAssembly.Module.exports(module));
    //     console.log(WebAssembly.Module.imports(module));
    //     return WebAssembly.instantiate(module, {
    //       env:{
    //         _ZN4core9panicking5panic17hfbb77505dc622acdE:alert
    //       }
    //     });
    //   })
    //   .then(instance => {
    //       console.log(instance)
    //     alert(instance.exports.rsum(13,14,15));
    //   });

        import { WASI } from "https://unpkg.com/@wasmer/wasi@0.12.0/lib/index.esm.js";
        import { WasmFs } from "https://unpkg.com/@wasmer/wasmfs@0.12.0/lib/index.esm.js";

        // import { lowerI64Imports } from "@wasmer/wasm-transformer"

        // import { WasmFs } from "@wasmer/wasmfs";

        // Instantiate a new WASI Instance
        const wasmFs = new WasmFs();
        let wasi = new WASI({
            args: [],
            env: {},
            bindings: {
                // uses browser APIs in the browser, node APIs in node
                ...WASI.defaultBindings,
                fs: wasmFs.fs
            }
        });

        const startWasiTask = async () => {
            // Fetch our Wasm File
            const response = await fetch("./perspective.wasm");
            const responseArrayBuffer = await response.arrayBuffer();

            // Instantiate the WebAssembly file
            const wasm_bytes = new Uint8Array(responseArrayBuffer).buffer;
            // const lowered_wasm = await lowerI64Imports(wasm_bytes);
            let module = await WebAssembly.compile(wasm_bytes);
            console.log(WebAssembly.Module.exports(module));
            console.log(WebAssembly.Module.imports(module));
            let instance = await WebAssembly.instantiate(module, {
                ...wasi.getImports(module)
            });

            // Start the WebAssembly WASI instance!
            wasi.start(instance);
            console.log(instance.exports.rsum(1,2,3));

            // Output what's inside of /dev/stdout!
            const stdout = await wasmFs.getStdOut();
            console.log(stdout);
        };
        startWasiTask();
  </script>